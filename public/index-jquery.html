<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Frase do Dia — jQuery</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; margin: 2rem; }
    .card { max-width: 820px; padding: 1.25rem 1.5rem; border: 1px solid #e5e7eb; border-radius: 16px; }
    .quote { font-size: 1.35rem; line-height: 1.7; }
    .author { margin-top: .75rem; opacity: .78; }
    .meta { margin-top: .5rem; font-size: .9rem; opacity: .65; }
    .muted { opacity: .6; }
    @media (prefers-color-scheme: dark) { .card { border-color: #374151; } }
  </style>
</head>
<body>
  <h1>Frase do Dia <span class="muted">· jQuery</span></h1>
  <p class="muted">Este exemplo tenta uma API externa (Quotable). Se falhar, usa <code>quotes.php</code> e seleção determinística.</p>
  <div class="card">
    <div id="quote" class="quote">Carregando…</div>
    <div id="author" class="author"></div>
    <div id="meta" class="meta"></div>
  </div>

  <script>
    const TZ = 'America/Sao_Paulo';
    const SALT = 'v1-rotacao-anual';

    function todayInTZ() {
      const now = new Date();
      const parts = new Date(now.toLocaleString('en-US', { timeZone: TZ }));
      const yyyy = parts.getFullYear();
      const mm = String(parts.getMonth()+1).padStart(2,'0');
      const dd = String(parts.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function djb2(str){ let h=5381; for(let i=0;i<str.length;i++){ h=((h<<5)+h)+str.charCodeAt(i); } return h>>>0; }
    function pickForDate(dateStr, salt, quotes){
      const idx = djb2(`${dateStr}|${salt}`) % quotes.length;
      return quotes[idx];
    }

    $(async function(){
      const date = todayInTZ();
      const key = `qotd:${date}`;
      const cached = localStorage.getItem(key);
      if (cached) { render(JSON.parse(cached)); return; }

      // tenta API externa
      try {
        const ext = await $.ajax({ url: 'https://favqs.com/api/qotd', dataType: 'json', cache: false });
        if (ext && ext.content) {
          const payload = { id: ext._id, quote: ext.content, author: ext.author || null, source: 'quotable', lang: 'en', date, timezone: TZ };
          localStorage.setItem(key, JSON.stringify(payload));
          render(payload);
          return;
        }
      } catch(e) {}

      // cai para local
      const quotes = await $.getJSON('./quotes.php');
      const q = pickForDate(date, SALT, quotes);
      const payload = { ...q, source: q.source || 'local', date, timezone: TZ };
      localStorage.setItem(key, JSON.stringify(payload));
      render(payload);
    });

    function render(q){
      $('#quote').text(`“${q.quote}”`);
      $('#author').text(q.author ? `— ${q.author}` : '');
      $('#meta').text(`${q.timezone || TZ} · ${q.date || ''} · fonte: ${q.source || 'local'}`);
    }
  </script>
</body>
</html>
