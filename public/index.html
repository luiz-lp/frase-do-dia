<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Frase do Dia — Vanilla JS</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; margin: 2rem; }
    .card { max-width: 820px; padding: 1.25rem 1.5rem; border: 1px solid #e5e7eb; border-radius: 16px; }
    .quote { font-size: 1.35rem; line-height: 1.7; }
    .author { margin-top: .75rem; opacity: .78; }
    .meta { margin-top: .5rem; font-size: .9rem; opacity: .65; }
    .muted { opacity: .6; }
    @media (prefers-color-scheme: dark) { .card { border-color: #374151; } }
  </style>
</head>
<body>
  <h1>Frase do Dia <span class="muted">· Vanilla JS</span></h1>
  <p class="muted">Este exemplo tenta uma API externa (Quotable). Se falhar, usa <code>quotes.php</code> (fonte local) e seleciona a frase determinística por dia/fuso.</p>
  <div class="card">
    <div id="quote" class="quote">Carregando…</div>
    <div id="author" class="author"></div>
    <div id="meta" class="meta"></div>
  </div>

  <script type="module">
    const TZ = 'America/Sao_Paulo';
    const SALT = 'v1-rotacao-anual';

    const todayInTZ = () => {
      const now = new Date();
      const parts = new Date(now.toLocaleString('en-US', { timeZone: TZ }));
      const yyyy = parts.getFullYear();
      const mm = String(parts.getMonth()+1).padStart(2,'0');
      const dd = String(parts.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    };

    const djb2 = (str) => {
      let h = 5381;
      for (let i = 0; i < str.length; i++) h = ((h << 5) + h) + str.charCodeAt(i);
      return h >>> 0;
    };

    const pickForDate = (dateStr, salt, quotes) => {
      const key = `${dateStr}|${salt}`;
      const idx = djb2(key) % quotes.length;
      return quotes[idx];
    };

    const readCache = (dateStr) => {
      try { return JSON.parse(localStorage.getItem(`qotd:${dateStr}`)); } catch { return null; }
    };
    const writeCache = (dateStr, data) => {
      try { localStorage.setItem(`qotd:${dateStr}`, JSON.stringify(data)); } catch {}
    };

    async function fetchLocalQuotes() {
      const res = await fetch('./quotes.php', { cache: 'no-store' });
      if (!res.ok) throw new Error('Falha ao carregar quotes');
      return res.json();
    }

    async function fetchExternalQotd() {
      try {
        const res = await fetch('https://favqs.com/api/qotd', { cache: 'no-store' });
        if (!res.ok) return null;
        const j = await res.json();
        if (!j?.content) return null;
        return { id: j._id, quote: j.content, author: j.author ?? null, source: 'quotable', lang: 'en', tags: j.tags ?? [] };
      } catch { return null; }
    }

    (async () => {
      const date = todayInTZ();
      const cached = readCache(date);
      if (cached) { render(cached); return; }

      const external = await fetchExternalQotd();
      if (external) { writeCache(date, { ...external, date, timezone: TZ }); render(external); return; }

      const quotes = await fetchLocalQuotes();
      const q = pickForDate(date, SALT, quotes);
      const payload = { ...q, source: q.source ?? 'local', date, timezone: TZ };
      writeCache(date, payload);
      render(payload);
    })();

    function render(q) {
      document.getElementById('quote').textContent = `“${q.quote}”`;
      document.getElementById('author').textContent = q.author ? `— ${q.author}` : '';
      document.getElementById('meta').textContent = `${q.timezone ?? TZ} · ${q.date ?? ''} · fonte: ${q.source ?? 'local'}`;
    }
  </script>
</body>
</html>
